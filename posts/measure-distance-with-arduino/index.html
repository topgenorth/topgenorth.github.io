<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Measuring Distance with Arduino - Opgenorth.NET</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title=Opgenorth.NET rel=home><div class="logo__item logo__text"><div class=logo__title>Opgenorth.NET</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/posts/><span class=menu__text>Blog</span></a></li><li class=menu__item><a class=menu__link href=/gallery/><span class=menu__text>Travel Gallery</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Measuring Distance with Arduino</h1></header><div class="content post__content clearfix"><p>The <a href=http://www.parallax.com/product/28015>Ping)))</a> is ultrasonic range finder that is pretty easy to use in an Arduino project. In my case, I&rsquo;m using it to monitor the water level in a sump pump. I have an Arduino Uno R3 (with Ethernet Shield) connected to a Ping))) and a <a href=https://www.sparkfun.com/products/10988>TMP36</a> temperature sensor that is perched above my sump pump. Every 2 minutes the Uno will send out a ping, and figure out the distance to the water below. The TMP36 is used to account for the air temperature in the speed of sound calculations.</p><h2 id=how-it-works>How It Works</h2><p>For now, I&rsquo;m just going to discuss the code I use. At some point in the future (maybe/hopefully) I&rsquo;ll loop back and include the schematic for the hardware.</p><p>There are two key parts to this sketch:</p><ol><li>Read the temperature from the TMP36 (convert to Celsius).</li><li>Send out the ping and measure the distance to the water surface.</li></ol><p>Each time the <code>loop</code> runs, the values from each sensor will be stored in the following structure.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * tmp36_sensor - The raw value from the tmp36 sensor
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * temperature  - Temperature in Celsius
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * ping_sensor  - The duration of the PING))), in microseconds
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * distance     - The distance to the object, in millimetres
</span></span></span><span style=display:flex><span><span style=color:#75715e>  */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> SensorValues {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> tmp36_sensor;                                   
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>float</span> temperature;                                  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> ping_sensor;                          
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> distance;                                       
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>At the end of <code>loop</code>, the <code>SensorValues</code> will be written to a text file on a micro SD card as CSV values.</p><h2 id=reading-the-temperature>Reading the Temperature</h2><p>Let&rsquo;s look at the first routine. I don&rsquo;t expect the temperature to change to dramatically, so I only update the temperature every 10 minutes.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * If enough time has elapsed since the last temperature reading, this function
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * will convert the tmp36 sensor values to Celsius.
</span></span></span><span style=display:flex><span><span style=color:#75715e>  */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>update_temperature</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> current_millis <span style=color:#f92672>=</span> <span style=color:#a6e22e>millis</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> time_diff <span style=color:#f92672>=</span> <span style=color:#a6e22e>abs</span>(current_millis <span style=color:#f92672>-</span> last_measurement_time);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (time_diff <span style=color:#f92672>&gt;=</span> TEMPERATURE_READING_DELAY) {
</span></span><span style=display:flex><span>    sensor_values.tmp36_sensor <span style=color:#f92672>=</span> <span style=color:#a6e22e>analogRead</span>(TEMP_SENSOR_PIN);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>convert_tmp36_reading_to_celsius</span>();
</span></span><span style=display:flex><span>    last_measurement_time <span style=color:#f92672>=</span> <span style=color:#a6e22e>millis</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>For the sake of completeness, here is the code to convert the sensor value from the TMP36 into degrees Celsius:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>float</span> <span style=color:#a6e22e>convert_tmp36_reading_to_celsius</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>int</span> adjusted_sensor_value<span style=color:#f92672>=</span> sensor_values.tmp36_sensor <span style=color:#f92672>+</span> TMP36_ADJUSTMENT; 
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>float</span> volts <span style=color:#f92672>=</span> (adjusted_sensor_value <span style=color:#f92672>*</span> SUPPLY_VOLTAGE) <span style=color:#f92672>/</span> <span style=color:#ae81ff>1024</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>float</span> adjustedVoltage <span style=color:#f92672>=</span> (volts <span style=color:#f92672>-</span> <span style=color:#ae81ff>500.0</span>);  
</span></span><span style=display:flex><span>  sensor_values.temperature <span style=color:#f92672>=</span> adjustedVoltage <span style=color:#f92672>/</span> <span style=color:#ae81ff>10.0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This code is pretty simple. One of my TMP36 sensors is a bit&mldr;weird. It seems to be miscalibrated or perhaps damaged. The constant <code>TMP36_ADJUSTMENT</code> is my attempt to correct the readings from that one particular sensor. I&rsquo;ve since bought some new TMP36s, so the value of this constant is 0.</p><h2 id=determining-the-distance>Determining the Distance</h2><p>Once we have the air temperature, we can figure out how far away the water is from the Ping))). Let&rsquo;s first look at the code, followed by a quick explaination:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>update_distance</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> ping_value <span style=color:#f92672>=</span> <span style=color:#a6e22e>read_ping_value</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> ping_delta <span style=color:#f92672>=</span> <span style=color:#a6e22e>abs</span>(ping_value <span style=color:#f92672>-</span> sensor_values.ping_sensor);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (ping_delta <span style=color:#f92672>&gt;=</span> MEANINGFUL_DISTANCE_DELTA) {
</span></span><span style=display:flex><span>    sensor_values.ping_sensor <span style=color:#f92672>=</span> ping_value;  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>convert_ping_duration_to_distance</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The first thing we do is retrieve the time (in microseconds) it takes the sound pulse to hit the surface of the water and bounce back (stored in <code>ping_value</code>). I noticed that <code>ping_value</code> will fluctuate a bit, even though the water level in the sump hasn&rsquo;t. <code>ping_value</code> must change by a significant amount (I&rsquo;m using 7 microseconds right now) before the ping value will be accepted. This function will return a value of 1 to indicate the distance has been updated.</p><h3 id=reading-values-from-the-ping>Reading Values from the Ping)))</h3><p>The Ping))) uses the same pin for both sending and receiving the ultrasonic pulse. The PING))) is triggered by a HIGH pulse of 2 or more microseconds. In this example, we&rsquo;ll send out a short LOW pulse for 2 microseconds to clean things up for a 5 microsecond HIGH pulse. After the pulse has been sent, the Ardunio will listen for the return pulse. Here is the code that does this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>read_ping_value</span>() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Setup for the output.
</span></span></span><span style=display:flex><span>    <span style=color:#a6e22e>pinMode</span>(PING_SENSOR_PIN, OUTPUT);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// First a LOW pulse to clean things up
</span></span></span><span style=display:flex><span>    <span style=color:#a6e22e>digitalWrite</span>(PING_SENSOR_PIN, LOW);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>delayMicroseconds</span>(<span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Now a HIGH pulse for the actual ping.
</span></span></span><span style=display:flex><span>    <span style=color:#a6e22e>digitalWrite</span>(PING_SENSOR_PIN, HIGH);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>delayMicroseconds</span>(<span style=color:#ae81ff>5</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>digitalWrite</span>(PING_SENSOR_PIN, LOW); 
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Listen for the return of the signal
</span></span></span><span style=display:flex><span>    <span style=color:#a6e22e>pinMode</span>(PING_SENSOR_PIN, INPUT);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pulseIn</span>(PING_SENSOR_PIN, HIGH);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=converting-the-ping-duration-to-a-distance>Converting the Ping Duration to a Distance</h3><p>Once we know how long a ping took, we can convert that to a distance. The speed of sound is 331.5 m/s, give or take. It does vary depending on air temperature and pressure. I&rsquo;m ignoring air pressure, largely because I don&rsquo;t have any Arduino sensors to measure it. Adjusting the speed of sound for the air temperature is a pretty trivial caculation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>float</span> <span style=color:#a6e22e>speed_of_sound</span>(<span style=color:#66d9ef>float</span> temperature) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>float</span> adjustment <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.606</span> <span style=color:#f92672>*</span> temperature;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> SPEED_OF_SOUND <span style=color:#f92672>+</span> adjustment;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now that we have the speed of sound (in metres per second), we can easily calculate the distance that the ping travelled. Here&rsquo;s another code example showing how:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>convert_ping_duration_to_distance</span>() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// correct the speed of sound based on the air temperature, in metres per second
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>float</span> adjustedSpeedOfSound <span style=color:#f92672>=</span> <span style=color:#a6e22e>speed_of_sound</span>(sensor_values.temperature);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Now we find the net distance the ping travelled (i.e from the sensor, to the object, and then back).
</span></span></span><span style=display:flex><span>  <span style=color:#75715e>// This value is in millimetres.
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>float</span> netDistance <span style=color:#f92672>=</span>  (sensor_values.ping_sensor <span style=color:#f92672>*</span> adjustedSpeedOfSound) <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000.0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// The distance to the object, in millimetres, is 1/2 of the total distance.
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> distance <span style=color:#f92672>=</span> netDistace <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>  sensor_values.distance <span style=color:#f92672>=</span> distance;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>There is, of course, other code to this sketch, but it&rsquo;s the boring stuff that has to do with initialization and writing to the micro SD card. If you want to look at the complete sketch, you can find the code on in my <a href=https://github.com/topgenorth/arduino/blob/master/DistanceFinder/DistanceFinder.ino>arduino repository on Github</a>.</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 000-6 3 3 0 000 6"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/arduino/ rel=tag>arduino</a></li></ul></div></footer></article></main></div><aside class=sidebar><div class="widget-search widget"><form class=widget-search__form role=search method=get action=https://google.com/search><input class=widget-search__field type=search placeholder=Search… name=q aria-label=Search…>
<input class=widget-search__submit type=submit value=Search>
<input type=hidden name=sitesearch value=https://topgenorth.github.io/></form></div><div class="widget-recent widget"><h4 class=widget__title>Recent Posts</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/posts/reforming-brass/>Reforming brass for the Mauser 98k</a></li><li class=widget__item><a class=widget__link href=/posts/ballistics-of-norinco-762x51/>Ballistics of Norinco 7.62x51</a></li><li class=widget__item><a class=widget__link href=/posts/ballistics-of-norinco-762x39/>Ballistics of Norinco 7.62x39</a></li><li class=widget__item><a class=widget__link href=/posts/wiring-up-a-nest/>Wiring Up a 2nd Generation Nest</a></li><li class=widget__item><a class=widget__link href=/posts/measure-distance-with-arduino/>Measuring Distance with Arduino</a></li><li class=widget__item><a class=widget__link href=/posts/sublime-text-and-arduino/>Sublime Text 2 and Arduino</a></li><li class=widget__item><a class=widget__link href=/posts/write-gps-to-jpg/>Embed GPS in a JPEG</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>Categories</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/categories/firearms/>Firearms</a></li><li class=widget__item><a class=widget__link href=/categories/personal/>Personal</a></li><li class=widget__item><a class=widget__link href=/categories/programming/>Programming</a></li><li class=widget__item><a class=widget__link href=/categories/technology/>Technology</a></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>Tags</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/tags/.net/ title=.NET>.NET</a>
<a class="widget-taglist__link widget__link btn" href=/tags/7.62x51/ title=7.62x51>7.62x51</a>
<a class="widget-taglist__link widget__link btn" href=/tags/7.92x57/ title=7.92x57>7.92x57</a>
<a class="widget-taglist__link widget__link btn" href=/tags/alt.net/ title=ALT.NET>ALT.NET</a>
<a class="widget-taglist__link widget__link btn" href=/tags/android/ title=Android>Android</a>
<a class="widget-taglist__link widget__link btn" href=/tags/arduino/ title=Arduino>Arduino</a>
<a class="widget-taglist__link widget__link btn" href=/tags/ballistics/ title=Ballistics>Ballistics</a>
<a class="widget-taglist__link widget__link btn" href=/tags/c%23/ title=C#>C#</a>
<a class="widget-taglist__link widget__link btn" href=/tags/javascript/ title=JavaScript>JavaScript</a>
<a class="widget-taglist__link widget__link btn" href=/tags/linux/ title=Linux>Linux</a>
<a class="widget-taglist__link widget__link btn" href=/tags/mono/ title=Mono>Mono</a>
<a class="widget-taglist__link widget__link btn" href=/tags/rant/ title=Rant>Rant</a>
<a class="widget-taglist__link widget__link btn" href=/tags/reloading/ title=Reloading>Reloading</a>
<a class="widget-taglist__link widget__link btn" href=/tags/samoyed/ title=Samoyed>Samoyed</a>
<a class="widget-taglist__link widget__link btn" href=/tags/tdd/ title=TDD>TDD</a>
<a class="widget-taglist__link widget__link btn" href=/tags/technology/ title=Technology>Technology</a>
<a class="widget-taglist__link widget__link btn" href=/tags/windows/ title=Windows>Windows</a>
<a class="widget-taglist__link widget__link btn" href=/tags/xamarin/ title=Xamarin>Xamarin</a>
<a class="widget-taglist__link widget__link btn" href=/tags/yeg/ title=YEG>YEG</a></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2026 Opgenorth.NET.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>