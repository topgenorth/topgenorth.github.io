--- 
layout: post
title: TFS 2010, VS2010 Database Projects, and CI
tags: 
- .NET
- Continous Integration
status: publish
type: post
published: true
meta: {}

---
<p>I’m currently working on a project where there are some functional tests that require a SQL Server database. Before in the past I’ve always handled this by using Redgate’s excellent SQL Server tools to create a monolithic script that would deploy the DB Schema, and then another set of scripts to set up the data.&#160; Then it’s pretty trivial to use OSQL.EXE to run the scripts and setup the database.</p>  <p>However, in this case, I’m constrained to use the VS2010 database project and TFS Build.&#160; So, the trick for me became how to use TFS 2010 Team Build to deploy a fresh copy of the database before the functional tests are run.&#160; After a bit of jiggery-pokery, here is what I ended up doing.&#160; I’m sure that at some point in my future, I will have to do this again, and nothing helps my failing memory like writing it down.</p>  <p>First a rough overview:</p>  <ol>   <li>Declare some variables to hold the physical path of my .dbproj and the default data path for SQL Server. </li>    <li>Convert the source code control path of my .dbproj to the physical path on disk. </li>    <li>To help with debugging and diagnostics, write a build message with the location of the physical path of the .dbproj </li>    <li>Add an MSBuild task to my workflow that would deploy the .dbproj. </li> </ol>  <p>Without further adieu, here is more details breakdown of the steps involved.</p>  <h4>Declare Variables</h4>  <p>So, first things first – declare the two variables I need to hold the physical path to the .dbproj file, and the directory for my SQL Server databases.&#160; This should be pretty simple and straight forward (assuming that the POS that is the “Workflow Designer” isn’t crashing VS2010 constantly).</p>  <p><a href="http://www.opgenorth.net/wp-content/uploads/2010/11/image.png"><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.opgenorth.net/wp-content/uploads/2010/11/image_thumb.png" width="1000" height="379" /></a></p>  <p>Once that is out of the way I scrolled down the pretty, crashy, workflow designer until I came across the <u>Compile and Test</u> sequence.&#160; At the very start of it I added a sequence that I called <u>Deploy Database</u>.&#160; Inside this sequence I added the following Team Foundation Build Activities:</p>  <h4>ConvertWorkspaceItem</h4>  <p>The point to this BuildActivity is to figure where the hell on the file system TFS put one of the files.&#160; Pretty straight forward:</p>  <p><a href="http://www.opgenorth.net/wp-content/uploads/2010/11/image1.png"><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.opgenorth.net/wp-content/uploads/2010/11/image_thumb1.png" width="691" height="192" /></a></p>  <h4>WriteBuildMessage</h4>  <p>Always nice to have a message in your log file to help with troubleshooting.&#160; Here’s what my WriteBuildMessage activity looks like.&#160; Notice that the message makes use of the “DbProjectPath” variable that we set above in the ConvertWorkspaceItemActivity.</p>  <p><a href="http://www.opgenorth.net/wp-content/uploads/2010/11/image2.png"><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.opgenorth.net/wp-content/uploads/2010/11/image_thumb2.png" width="687" height="146" /></a></p>  <h4>MSBuild</h4>  <p>This the working part of the the sequence.&#160; In here we use MSBuild to call the .dbproj and deploy a fresh copy of the database to SQL Server. Key properties to set:</p>  <ul>   <li>CommandLineArguments : this contains the properties to pass on the command line when deploying.&#160; You’ll want to provide these properties      <ul>       <li>/p:TargetDatabase=YOUR_DATABASE_NAME </li>        <li>/p:”DefaultDataPath=DIRECTORY_OF_DATABASE_FILES” </li>        <li>/p:”TargetConnectionString=YOUR_CONNECTION_STRING_FOR_THE_TARGET_DATABASE” </li>        <li>/p:DeployToDatabase=True </li>     </ul>   </li>    <li>Configuration : just specify which configuration in the solution to use. </li>    <li>DisplayName : what ever you want, this is how the MSBuild activity will be displayed in your sequence </li>    <li>LogFile : the name of the log file for the deploy </li>    <li>OutDir : the output directory </li>    <li>Project : Notice that this is the value of DbProjectPath, which we set above in our ConvertWorkItem </li>    <li>RunCodeAnalysis : Set this to CodeAnalysisOption.Never.&#160; Doesn’t make much sense to do code analysis on a database project. </li>    <li>Targets : </li> </ul>  <p>Here is what the properties look like for this particuar Build Activity:</p>  <p><a href="http://www.opgenorth.net/wp-content/uploads/2010/11/image3.png"><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.opgenorth.net/wp-content/uploads/2010/11/image_thumb3.png" width="648" height="493" /></a></p>  <p>Now all of this has to live somewhere.&#160; You might want to have this live somewhere else depending on when or how you want the database to deploy.&#160; In my case, as I wanted to deploy the database BEFORE my tests ran, I hunted through the workflow and found the sequence called <u>Run Tests</u>.&#160; I modified one side of the If condition to include a new sequence call <u>Deploy DB and Run Tests</u>:<a href="http://www.opgenorth.net/wp-content/uploads/2010/11/image4.png"><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.opgenorth.net/wp-content/uploads/2010/11/image_thumb4.png" width="501" height="349" /></a></p>  <p>Here is an overview of what my Deploy DB and Run Tests sequence looks like</p>  <p><a href="http://www.opgenorth.net/wp-content/uploads/2010/11/image5.png"><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.opgenorth.net/wp-content/uploads/2010/11/image_thumb5.png" width="257" height="502" /></a></p>  <p>&#160;</p>  <h4>After Thoughts</h4>  <p>To be honest, I found the whole process annoying and awkward.&#160; Sure, I didn’t have to edit a bunch of XML by hand, but the Workflow Designer in Visual Studio 2010 wasn’t exactly a joy to work with either.&#160; I don’t know exactly what the problem was, but it kept crashing while I was trying to edit this Build Process Template. It was always the same error, an Out of Memory Exception.&#160; On a Dell Latitude E6510 with 4GB of memory, this shouldn’t be happening.&#160; As well, the whole editing process for the work flow was awkward at best.</p>  <p>As much as I dislike XML based build tools, at least text editors don’t get all crashy and such.&#160; As well, I found the overall experience of trying to create and piece together the workflow for Team Build to be sluggish and tedious.&#160; It’s great to have a GUI editor to hide the crummy XML, but honestly, I think the way <a href="http://www.finalbuilder.com/home.aspx">FinalBuilder</a> works is far superior to how VS2010 in terms of easy of use and readability(application crashes aside).</p>  <p>Next is to setup my Release build definition, and to tackle the issue of updated the version number in AssemblyInfo.cs and creating a zip file of all the deployment artifacts.&#160; But first I’ve got to go and buy a bottle or two of Talisker to help numb the pain that will follow as I go done down that path.</p>
